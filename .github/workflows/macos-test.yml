name: macOS Auto-Resolve Test

on:
  workflow_dispatch:  # Allow manual triggering

jobs:
  test-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up SSH
      run: |
        # Generate SSH key for the runner
        ssh-keygen -t rsa -b 4096 -C "github-actions-macos" -f ~/.ssh/id_rsa -N ""
        
        # Start SSH service
        sudo launchctl load -w /System/Library/LaunchDaemons/ssh.plist
        
        # Set password for runner user (needed for your auto-resolve)
        echo "runner:test123" | sudo chpasswd
        
        # Allow password authentication
        sudo sed -i.bak 's/#PasswordAuthentication yes/PasswordAuthentication yes/g' /etc/ssh/sshd_config
        sudo sed -i.bak 's/#PermitRootLogin.*/PermitRootLogin yes/g' /etc/ssh/sshd_config
        
        # Restart SSH
        sudo launchctl stop com.openssh.sshd
        sudo launchctl start com.openssh.sshd
        
        # Get IP and display connection info
        echo "MACOS_IP=$(ipconfig getifaddr en0)" >> $GITHUB_ENV
        echo "SSH_PORT=22" >> $GITHUB_ENV
        cat ~/.ssh/id_rsa.pub

    - name: Install monitoring tools
      run: |
        # Install tools your auto-resolve needs
        brew install procps  # for ps, top, free commands
        # macOS has df, find, echo built-in

    - name: Display connection info
      run: |
        echo "üñ•Ô∏è macOS Runner is ready for SSH connection!"
        echo "IP: ${{ env.MACOS_IP }}"
        echo "Port: ${{ env.SSH_PORT }}"
        echo "Username: runner"
        echo "Password: test123"
        echo "‚è∞ This runner will be available for ~6 hours"
        
        # Keep the runner alive
        while true; do
          echo "$(date): Runner alive and waiting for connections..."
          sleep 300
        done
